antlr = ../code/0
unitest = unitest.0

// Test 1: Parse a simple grammar declaration
test_input = "grammar Test;"

result1 = antlr.parse({ input: test_input })

// Test 2: Parse grammar with whitespace
test_input2 = "  grammar  MyGrammar  ;  "

result2 = antlr.parse({ input: test_input2 })

// Test 3: Parse grammar with a parser rule
test_input3 = "grammar Expr;
expr: 'hello' 'world';"

result3 = antlr.parse({ input: test_input3 })

// Test 4: Parse grammar with a lexer rule
test_input4 = "grammar Tokens;
ID: [a-z];"

result4 = antlr.parse({ input: test_input4 })

// Test 5: Parse grammar with both parser and lexer rules
test_input5 = "grammar Simple;
prog: ID;
ID: [a-z];"

result5 = antlr.parse({ input: test_input5 })

// Test 6: Generate ANTLR grammar from AST (just declaration)
test_ast = {
  ws_start: ""
  grammar_decl: {
    kind: ""
    ws_kind: ""
    keyword: "grammar"
    ws1: " "
    name: "Example"
    ws2: ""
    semicolon: ";"
  }
  rules: []
  ws_end: ""
}

result6 = antlr.generate({ ast: test_ast })

unitest.display(
  unitest.describe({
    name: "ANTLR Grammar Parser Tests"
    tests: [
      unitest.describe({
        name: "Parse simple grammar declaration"
        tests: [
          unitest.equals([ result1.success 1 ])
          unitest.equals([ (result1.success == 1 ? result1.value.grammar_decl.name : "N/A") "Test" ])
        ]
      })
      unitest.describe({
        name: "Parse grammar with extra whitespace"
        tests: [
          unitest.equals([ result2.success 1 ])
          unitest.equals([ (result2.success == 1 ? result2.value.grammar_decl.name : "N/A") "MyGrammar" ])
        ]
      })
      unitest.describe({
        name: "Parse grammar with parser rule"
        tests: [
          unitest.equals([ result3.success 1 ])
          unitest.equals([ (result3.success == 1 ? result3.value.grammar_decl.name : "N/A") "Expr" ])
          unitest.equals([ (result3.success == 1 ? result3.value.rules[.] : 0) 1 ])
        ]
      })
      unitest.describe({
        name: "Parse grammar with lexer rule"
        tests: [
          unitest.equals([ result4.success 1 ])
          unitest.equals([ (result4.success == 1 ? result4.value.grammar_decl.name : "N/A") "Tokens" ])
          unitest.equals([ (result4.success == 1 ? result4.value.rules[.] : 0) 1 ])
        ]
      })
      unitest.describe({
        name: "Parse grammar with both rule types"
        tests: [
          unitest.equals([ result5.success 1 ])
          unitest.equals([ (result5.success == 1 ? result5.value.grammar_decl.name : "N/A") "Simple" ])
          unitest.equals([ (result5.success == 1 ? result5.value.rules[.] : 0) 2 ])
        ]
      })
      unitest.describe({
        name: "Generate ANTLR grammar from AST"
        tests: [
          unitest.equals([ result6.success 1 ])
          unitest.equals([ (result6.success == 1 ? result6.output : "N/A") "grammar Example;" ])
        ]
      })
      unitest.describe({
        name: "Single line comment"
        tests: (
          result = antlr.parse({
            input: "grammar Test; // comment"
          })
          [
            unitest.equals([ result.success 1 ])
          ]
        )
      })
      unitest.describe({
        name: "Multi-line comment"
        tests: (
          result = antlr.parse({
            input: "grammar Test; /* multi-line
comment */"
          })
          [
            unitest.equals([ result.success 1 ])
          ]
        )
      })
      unitest.describe({
        name: "Comment between rules"
        tests: (
          result = antlr.parse({
            input: "grammar Test;
// Parser rule
expr: ID;
/* Lexer rule */
ID: [a-z];"
          })
          [
            unitest.equals([ result.success 1 ])
          ]
        )
      })
      unitest.describe({
        name: "Nested multi-line comments"
        tests: (
          result = antlr.parse({
            input: "grammar Test; /* outer /* inner */ outer */"
          })
          [
            unitest.equals([ result.success 1 ])
          ]
        )
      })
      unitest.describe({
        name: "Comment at end of file"
        tests: (
          result = antlr.parse({
            input: "grammar Test;
expr: ID;
// End of grammar"
          })
          [
            unitest.equals([ result.success 1 ])
          ]
        )
      })
      unitest.describe({
        name: "Comment inside rule"
        tests: (
          result = antlr.parse({
            input: "grammar Test;
expr: /* part 1 */ 'hello' /* part 2 */ 'world';"
          })
          [
            unitest.equals([ result.success 1 ])
          ]
        )
      })
      unitest.describe({
        name: "Comment at the beginning"
        tests: (
          result = antlr.parse({
            input: "// starting comment
grammar Test;"
          })
          [
            unitest.equals([ result.success 1 ])
          ]
        )
      })
      unitest.describe({
        name: "Comment between grammar name and semicolon"
        tests: (
          result = antlr.parse({
            input: "grammar Test /* comment */ ;"
          })
          [
            unitest.equals([ result.success 1 ])
          ]
        )
      })
      unitest.describe({
        name: "Comment before lexer rule"
        tests: (
          result = antlr.parse({
            input: "grammar Test;
/* Lexer rule */
ID: [a-z];"
          })
          [
            unitest.equals([ result.success 1 ])
          ]
        )
      })
      unitest.describe({
        name: "Comment between rule elements"
        tests: (
          result = antlr.parse({
            input: "grammar Test;
expr: 'hello' // middle comment
      'world';"
          })
          [
            unitest.equals([ result.success 1 ])
          ]
        )
      })
      unitest.describe({
        name: "Lexer grammar declaration"
        tests: (
          result = antlr.parse({
            input: "lexer grammar MyLexer;"
          })
          [
            unitest.equals([ result.success 1 ])
            unitest.equals([ (result.success == 1 ? result.value.grammar_decl.kind : "N/A") "lexer" ])
            unitest.equals([ (result.success == 1 ? result.value.grammar_decl.ws_kind : "N/A") " " ])
            unitest.equals([ (result.success == 1 ? result.value.grammar_decl.name : "N/A") "MyLexer" ])
          ]
        )
      })
      unitest.describe({
        name: "Parser grammar declaration"
        tests: (
          result = antlr.parse({
            input: "parser grammar MyParser;"
          })
          [
            unitest.equals([ result.success 1 ])
            unitest.equals([ (result.success == 1 ? result.value.grammar_decl.kind : "N/A") "parser" ])
            unitest.equals([ (result.success == 1 ? result.value.grammar_decl.ws_kind : "N/A") " " ])
            unitest.equals([ (result.success == 1 ? result.value.grammar_decl.name : "N/A") "MyParser" ])
          ]
        )
      })
      unitest.describe({
        name: "Generate lexer grammar from AST"
        tests: (
          test_ast_lexer = {
            ws_start: ""
            grammar_decl: {
              kind: "lexer"
              ws_kind: " "
              keyword: "grammar"
              ws1: " "
              name: "MyLexer"
              ws2: ""
              semicolon: ";"
            }
            rules: []
            ws_end: ""
          }
          result_lexer = antlr.generate({ ast: test_ast_lexer })
          [
            unitest.equals([ result_lexer.success 1 ])
            unitest.equals([ (result_lexer.success == 1 ? result_lexer.output : "N/A") "lexer grammar MyLexer;" ])
          ]
        )
      })
      repro_issue_6
      test_alts
      test_lexer
      test_mode
      test_to_dialect
    ]
  })
)

